<html>
<head>
  <title>Woopsa Arduino demo</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
  <style>
  .digital-io-status{
	position: relative;
	width: 15px;
	height: 15px;
	top: 4px;
  }
  .digital-io-status:before{
	content: '';
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-color: #fff;
  }
  .digital-io-status:after{
	content: '';
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	border: 1px solid #700;
	border-radius: 50%;
	background-color: #f33;
	box-shadow: 0 0 5px rgba(0,0,0,0.5) inset;
	cursor: pointer;
  }
  .digital-io-status:checked:after{
	background-color: #3f3;
	border-color: #070;
  }
  </style>
</head>
<body>
	<div class="container">
		<h1>Woopsa Arduino demo</h1>
		<div class="row">
			<div class="col-xs-6 form-horizontal io-group analog-inputs">
				<h4>Analog inputs</h4>
				<div class="form-group"><label class="col-xs-2 control-label">A0</label><div class="col-xs-10"><div class="progress"><div class="progress-bar" data-woopsa-property="AnalogIn0"></div></div></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">A1</label><div class="col-xs-10"><div class="progress"><div class="progress-bar" data-woopsa-property="AnalogIn1"></div></div></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">A2</label><div class="col-xs-10"><div class="progress"><div class="progress-bar" data-woopsa-property="AnalogIn2"></div></div></div></div>
			</div>
			<div class="col-xs-6 form-horizontal io-group analog-inputs">
				<h4>&nbsp;</h4>
				<div class="form-group"><label class="col-xs-2 control-label">A3</label><div class="col-xs-10"><div class="progress"><div class="progress-bar" data-woopsa-property="AnalogIn3"></div></div></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">A4</label><div class="col-xs-10"><div class="progress"><div class="progress-bar" data-woopsa-property="AnalogIn4"></div></div></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">A5</label><div class="col-xs-10"><div class="progress"><div class="progress-bar" data-woopsa-property="AnalogIn5"></div></div></div></div>
			</div>
		</div>
		<div class="row">
			<div class="col-xs-6 form-horizontal io-group digital-ios">
				<h4>Digital I/Os</h4>
				<div class="form-group"><label class="col-xs-2 control-label">D0</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital0"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode0"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D1</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital1"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode1"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D2</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital2"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode2"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D3</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital3"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode3"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D4</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital4"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode4"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D5</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital5"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode5"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D6</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital6"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode6"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
			</div>
			<div class="col-xs-6 form-horizontal io-group pwms">
				<h4>&nbsp;</h4>
				<div class="form-group"><label class="col-xs-2 control-label">D7</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital7"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode7"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D8</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital8"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode8"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D9</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital9"/></div><div class="col-xs-9"><select class="form-control" data-woopsa-property="PinMode9"><option value="0">Input</option><option value="1">Output</option><option value="2">Input (pullup)</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D10</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital3" disabled /></div><div class="col-xs-9"><select class="form-control" disabled><option value="0">Reserved</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D11</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital4" disabled /></div><div class="col-xs-9"><select class="form-control" disabled><option value="0">Reserved</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D12</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital5" disabled /></div><div class="col-xs-9"><select class="form-control" disabled><option value="0">Reserved</option></select></div></div>
				<div class="form-group"><label class="col-xs-2 control-label">D13</label><div class="col-xs-1"><input class="digital-io-status" type="checkbox" data-woopsa-property="Digital6" disabled /></div><div class="col-xs-9"><select class="form-control" disabled><option value="0">Reserved</option></select></div></div>
			</div>
		</div>
	</div>
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script type="text/javascript">(function(global){var nop=function(){};var Subscription=function(channel,path,onChangeCallback,successCallback,monitorInterval,publishInterval){this.channel=channel;this.path=path;this.onChange=onChangeCallback||nop;this.subscriptionId=null;monitorInterval=monitorInterval||.02;publishInterval=publishInterval||.05;successCallback=successCallback||nop;this.unregister=function(successCallback){return channel.client.invoke("/SubscriptionService/UnregisterSubscription",{SubscriptionChannel:channel.channelId,SubscriptionId:this.subscriptionId},function(result){successCallback()}.bind(this))};this.register=function(callback){return channel.client.invoke("/SubscriptionService/RegisterSubscription",{SubscriptionChannel:channel.channelId,PropertyLink:path,MonitorInterval:monitorInterval,PublishInterval:publishInterval},function(result){this.subscriptionId=result;successCallback();if(callback){callback(this)}}.bind(this))};this.register.call(this)};var SubscriptionChannel=function(client,notificationQueueSize,onCreateCallback){this.client=client;this.onCreate=onCreateCallback;this.channelId=null;this.subscriptions=[];this.listenStarted=false;this.subscriptionsDictionary={};var created=false;var channelLastNotificationId=0;this.registerSubscription=function(path,onChangeCallback,successCallback,monitorInterval,publishInterval){var newSubscription=new Subscription(this,path,onChangeCallback,function(){this.subscriptionsDictionary[newSubscription.subscriptionId]=newSubscription;successCallback()}.bind(this),monitorInterval,publishInterval);this.subscriptions.push(newSubscription);if(!this.listenStarted){this.listenStarted=true;waitNotification.call(this)}return newSubscription};this.unregisterSubscription=function(subscription,successCallback){var subscriptionIndex=this.subscriptions.indexOf(subscription);if(subscriptionIndex!=-1){this.subscriptions[subscriptionIndex].unregister(function(subscriptionIndex,successCallback){this.subscriptions.splice(subscriptionIndex,1);successCallback()}.bind(this,subscriptionIndex,successCallback))}};this.register=function(){return client.invoke("/SubscriptionService/CreateSubscriptionChannel",{NotificationQueueSize:notificationQueueSize},function(result){this.channelId=result;if(!created)this.onCreate.call(this,this.channelId);created=true}.bind(this))};this.register.call(this);var retryFrequency=1e4;var waitNotification=function(lastNotificationId){if(typeof lastNotificationId=="undefined"){lastNotificationId=channelLastNotificationId}return client.invoke("/SubscriptionService/WaitNotification",{SubscriptionChannel:this.channelId,LastNotificationId:lastNotificationId},function(notifications){for(var i=0;i<notifications.length;i++){var notification=notifications[i];if(this.subscriptionsDictionary[notification.SubscriptionId]){this.subscriptionsDictionary[notification.SubscriptionId].onChange(notification.Value.Value);if(notification.Id>channelLastNotificationId)channelLastNotificationId=notification.Id}}waitNotification.call(this)}.bind(this)).fail(function(request,status,error){if(request.readyState==4){if(request.getResponseHeader("Content-Type")=="application/json"){var woopsaException=JSON.parse(request.responseText);if(woopsaException.Type=="WoopsaInvalidSubscriptionChannelException"){this.register().done(function(){for(var i=0;i<this.subscriptions.length;i++){this.subscriptions[i].register()}}.bind(this));setTimeout(function(){waitNotification.call(this,channelLastNotificationId)}.bind(this),retryFrequency)}else if(woopsaException.Type=="WoopsaNotificationsLostException"){waitNotification.call(this,0)}}}else{setTimeout(function(){waitNotification.call(this,channelLastNotificationId)}.bind(this),retryFrequency)}}.bind(this))}};global.WoopsaClient=function(url,jQuery){var $=jQuery;var subscriptionChannel=null;var errorCallbacks=[];var WoopsaXHR=function(options){var innerXHR=$.ajax(options);this.done=function(callback){innerXHR.done(callback);return this};this.fail=function(callback){innerXHR.fail(callback);return this};this.then=function(done,fail){innerXHR.then(done);innerXHR.fail(fail);return this};this.always=function(callback){innerXHR.always(callback);return this}};var WoopsaDeferredXHR=function(options){var doneCallbacks=[];var failCallbacks=[];var alwaysCallbacks=[];var options=options||{};var innerXHR=null;this.done=function(callback){doneCallbacks.push(callback);return this};this.fail=function(callback){failCallbacks.push(callback);return this};this.then=function(done,fail){doneCallbacks.push(done);failCallbacks.push(fail);return this};this.always=function(callback){alwaysCallbacks.push(callback);return this};this.execute=function(){innerXHR=new WoopsaXHR(options);for(var i=0;i<doneCallbacks.length;i++)innerXHR.done(doneCallbacks[i]);for(var i=0;i<failCallbacks.length;i++)innerXHR.fail(failCallbacks[i]);for(var i=0;i<alwaysCallbacks.length;i++)innerXHR.always(alwaysCallbacks[i]);return innerXHR}};var xhrQueue=[];var WoopsaAjax=function(options,useQueue){if(!useQueue){return new WoopsaXHR(options)}else{var newXHR=new WoopsaDeferredXHR(options);newXHR.always(function(){xhrQueue.splice(0,1);if(xhrQueue.length>0)xhrQueue[0].execute()});xhrQueue.push(newXHR);if(xhrQueue.length==1)newXHR.execute();return newXHR}};if(url.lastIndexOf("/")==url.length-1){this.url=url}else{this.url=url+"/"}this.username=null,this.password=null;this.useRequestQueue=false;this.read=function(path,callback){return WoopsaAjax({type:"GET",url:this.url+"read"+path,beforeSend:authenticateHeaders.bind(this)},this.useRequestQueue).done(function(data){callback(data.Value,path)}).fail(function(request,status,errorThrown){raiseError(status,errorThrown)})};this.write=function(path,value,callback){return WoopsaAjax({type:"POST",url:this.url+"write"+path,beforeSend:authenticateHeaders.bind(this),data:{value:value}},this.useRequestQueue).done(function(data){callback(true,path)}).fail(function(request,status,errorThrown){raiseError(status,errorThrown)})};this.meta=function(path,callback){return WoopsaAjax({type:"GET",url:this.url+"meta"+path,beforeSend:authenticateHeaders.bind(this)},this.useRequestQueue).done(function(data){callback(data,path)}).fail(function(request,status,errorThrown){raiseError(status,errorThrown)})};this.invoke=function(path,arguments,callback,timeout){timeout=timeout||1e4;arguments=arguments||{};callback=callback||function(){};return WoopsaAjax({type:"POST",timeout:timeout,beforeSend:authenticateHeaders.bind(this),url:this.url+"invoke"+path,data:arguments,dataType:"text"},this.useRequestQueue).done(function(data){if(data=="")callback();else callback(JSON.parse(data).Value)}).fail(function(request,status,errorThrown){raiseError(status,errorThrown)})};this.multiRequest=function(requests,callback){var internalRequests={};var allArguments=[];for(var i=0;i<requests.length;i++){var req=requests[i];internalRequests[req.Id]=req;allArguments.push({Id:req.Id,Action:req.Action,Path:req.Path,Value:req.Value,Arguments:req.Arguments})}return this.invoke("/MultiRequest",{Requests:JSON.stringify(allArguments)},function(data){for(var i=0;i<data.length;i++){var response=data[i];var internalRequest=internalRequests[response.Id];if(internalRequest.callback)internalRequest.callback(response.Result)}callback(data)}.bind(this))};this.createSubscriptionChannel=function(notificationQueueSize,callback){if(subscriptionChannel!=null){callback.call(subscriptionChannel,subscriptionChannel.channelId);return}var newChannel=new SubscriptionChannel(this,notificationQueueSize,function(channelId){callback.call(this,channelId)});subscriptionChannel=newChannel;return newChannel};var subscriptionChannelCreating=false;var queue=[];this.onChange=function(path,callback,monitorInterval,publishInterval){if(subscriptionChannelCreating){queue.push({path:path,callback:callback,monitorInterval:monitorInterval,publishInterval:publishInterval});return}if(subscriptionChannel==null&&!subscriptionChannelCreating){subscriptionChannelCreating=true;this.createSubscriptionChannel(200,function(){this.onChange(path,callback,monitorInterval,publishInterval);subscriptionChannelCreating=false;for(var i=queue.length-1;i>=0;i--){var elem=queue[i];subscriptionChannel.registerSubscription(elem.path,elem.callback,nop,elem.monitorInterval,elem.publishInterval);queue.splice(i,1)}}.bind(this))}else{subscriptionChannel.registerSubscription(path,callback,nop,monitorInterval,publishInterval)}};this.onError=function(callback){errorCallbacks.push(callback)};function raiseError(type,errorThrown){for(var i=0;i<errorCallbacks.length;i++){errorCallbacks[i](type,errorThrown)}}function authenticateHeaders(xhr){if(this.username!=null)xhr.setRequestHeader("Authorization","Basic "+btoa(this.username+":"+this.password))}}})(window);</script>
	<script type="text/javascript">
	$(document).ready(function (){
		var arduino = new WoopsaClient("/woopsa", jQuery);
		arduino.useRequestQueue = true;
		
		var doUpdate = function (){
			arduino.read("/" + $(this).attr("data-woopsa-property"), (function (propValue){
				if ($(this).hasClass("progress-bar")){
					$(this).css("width",(100*propValue/1023)+"%");
					$(this).html(propValue);
				}else if ($(this).attr("type") == "checkbox")
					$(this).prop("checked", (propValue)?true:false);
				else	
					$(this).val(propValue);
			}).bind(this));
		}
		
		$("[data-woopsa-property]").each(function (){
			if ($(this).attr("type") == "checkbox"){
				$(this).on("change", function (){
					arduino.write("/" + $(this).attr("data-woopsa-property"), $(this).prop("checked")?1:0, function (value){
					});
				});
			}else{	
				$(this).on("change", function (){
					arduino.write("/" + $(this).attr("data-woopsa-property"), $(this).val(), function (value){
					});
				});
			}
			
			setInterval(doUpdate.bind(this), 1000);
			doUpdate.call(this);
		});
	});
	</script>
</body>
</html>